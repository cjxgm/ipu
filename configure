#!/bin/bash
# vim: ft=sh noet ts=4 sw=4 sts=0

main()
{
	local OBJS=""
	local CCFLAGS="-std=gnu11 -Ilibcrude"
	local LDFLAGS="-Llibcrude -lcrude -lm"
	echo "# vim: ft=make noet ts=4 sw=4 sts=0" > makefile
	gen
	gen "CC = gcc"
	gen "CCFLAGS = -march=native -Ofast -Wall $CCFLAGS"
	gen "LDFLAGS = $LDFLAGS"
	gen
	gen ".PHONY: ipu clean cleanall rebuild reconf test commit"
	gen
	gen "ipu: build build/objects build/ipu"
	gen "clean:"
	gen -e "\trm -rf build"
	gen "cleanall: clean"
	gen -e "\trm -f makefile"
	gen "rebuild: clean build/ipu"
	gen "reconf:"
	gen -e "\t./configure"
	gen "test: build/ipu"
	gen -e "\tcd build && ./ipu && feh ipu-output"
	gen "commit: cleanall"
	gen -e "\tgit add ."
	gen -e "\tenv LANG=C git commit -a || true"
	gen -e "\t./configure"
	gen
	gen "build:"
	gen -e "\tmkdir build"
	gen "build/objects:"
	gen -e "\tmkdir build/objects"

	for f in src/*.c; do
		echo -e "\e[0;32mprocessing \e[1;35m$f\e[m"
		echo -ne "\e[1;31m"
		gcc $CCFLAGS -MM "$f" > .dep || error
		local target=build/objects/$(cut -d: -f1 .dep | head -n 1)
		OBJS="$OBJS $target";
		gen -n "build/objects/"
		cat .dep >> makefile
		gen -e "\t\$(CC) -c -o \$@ \$< \$(CCFLAGS)"
	done
	echo -ne "\e[m"
	rm -f .dep
	gen "build/ipu:$OBJS"
	gen -e "\t\$(CC) -o \$@ \$^ \$(LDFLAGS)"
	gen
}

gen()
{
	echo $* >> makefile
}

error()
{
	echo -ne "\e[m"
	rm -f .dep
	exit 1
}


main $*

